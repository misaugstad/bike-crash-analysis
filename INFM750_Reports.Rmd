---
title: "INFM_Reports"
author: "Yao Li, Yuhan Luo, Michael Saugstad"
output:
  html_document:
    fig-caption: yes
    highlight: tango
    theme: united
    toc: yes
  word_document: default
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo= TRUE, cache = TRUE)

```


![](http://www.martinezschill.com/images/bicycle-accidents.jpg)

# Introduction

This part involves the processing of NYC car crash data. We will select all the bicycle related car crash data, and visualize its time pattern and space pattern.

```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=T,eval=T,fig.width=9}
library(knitr)
library(kableExtra)
```

# Data on NYC OpenData about car crash 

![](https://opendata.cityofnewyork.us/wp-content/themes/opendata-wp/assets/img/nyc-open-data-logo.svg)

You can get the car crash data by going to the  [NYC OpenData](https://opendata.cityofnewyork.us/), do not need register, search "Car crash data", you can get the NYC car crash data.  There is then an option to download a csv file.

## Reading the Data in R

* Information on incidence in states is read as factors. Factors are categorical variables not numerical. This "coercion" was caused by the presence of characters that denote missing values.

> factors are variables in R which take on a limited number of different values; such variables are often refered to as categorical variables. One of the most important uses of factors is in statistical modeling; since categorical variables enter into statistical models differently than continuous variables, storing data as factors insures that the modeling functions will treat such data correctly. [Factors in R](https://www.stat.berkeley.edu/classes/s133/factors.html)
```{r, echo=TRUE,warning=FALSE,message=FALSE}
library(tidyverse)
setwd("~/Dropbox/bike_analysis")
classes <- c(replicate(4, "factor"), "numeric", "numeric", replicate(4, "factor"),
            replicate(8, "numeric"), replicate(5, "factor"), "numeric", replicate(5, "factor"))
crash.data <- read.csv("data/NYPD_Motor_Vehicle_Collisions.csv",
                  skip=0, header=T, na.strings=c("-", ""), colClasses = classes)

# Fixed date and time columns to have appropriate data types
crash.data$TIME <- as.POSIXct(crash.data$TIME, format = "%H:%M")
crash.data$DATE <- as.Date(crash.data$DATE, format = "%m/%d/%Y")

crash.data %>%
  head() %>%
  select(1:3,5:7,15:16) %>%
  kable("html") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

sapply(crash.data,class) %>% head() %>% kable("html")
```

# Patterns of Missingness


```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9}
knitr::opts_chunk$set(cache=TRUE)
library(VIM)
aggr(crash.data, col=c('darkgreen','tomato'), numbers=TRUE, sortVars=TRUE, labels=names(crash.data), cex.axis=.5, gap=2, ylab=c("Histogram of missing data","Pattern"))
```

# Tidy the Data
```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9}
crash.data %>% head() %>% select(1:3,5:7,15:16) %>% kable("html") %>%  kable_styling(bootstrap_options = c("striped", "hover"))
```

* To process and visualize data a 'tidy' form of the data is preferred
* Clearly column headers are values, not variable names.
* For presenting data in  tables the 'wide' or 'untidy' is usually preferable.

```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9}
crash.data -> crash.data.lon
crash.data.lon$incidence = as.numeric(crash.data.lon$NUMBER.OF.CYCLIST.INJURED+crash.data.lon$NUMBER.OF.CYCLIST.KILLED) 

crash.data.lon %>% head(12) %>% kable("html") %>% kable_styling(bootstrap_options = c("striped", "hover"))

```

* Note that there is a price to pay for this new arrangement. For example here the state names are now repeated for every week and year. So the size of the object increases substantially.

```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9}
dim(crash.data)
dim(crash.data.lon)
prod(dim(crash.data))
prod(dim(crash.data.lon))
```

* The 'wide' table has `prod(dim(crash.data) )` elements, while the 'lon' version has `prod(dim(crash.data.lon) )`.

```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9}
object.size(crash.data)
object.size(crash.data.lon)

( as.numeric(object.size(crash.data.lon)) - as.numeric(object.size(crash.data) ))/as.numeric(object.size(crash.data))

```


The NYC visualization aggregates incidence by year.

```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9}
pol <- crash.data.lon %>% group_by(BOROUGH, DATE) %>%  dplyr::summarise( c=sum(incidence, na.rm=T))
pol %>% head() %>% kable("html") %>%  kable_styling(bootstrap_options = c("striped", "hover"))
```
Now we have a tidy dataset. i.e.:

* Each variable forms a column.
* Each observation forms a row.
* Each type of observational unit forms a table.


# Filtering the data
For this I will use the _fields_ library
```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9,fig.height=9}
output <- filter(crash.data.lon,incidence>=1 , LATITUDE != "NA")

output %>% head(27) %>% select(1:2,5:6,30) %>% kable("html") %>%   kable_styling(bootstrap_options = c("striped", "hover"))

```


# Combine all the data within one day
```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9,fig.height=9}
output%>% select(1:2,5:6,30) %>%  group_by(DATE) %>% summarise( c=sum(incidence, na.rm=T)) %>%  kable("html") %>%   kable_styling(bootstrap_options = c("striped", "hover"))
```


# Visualizing the time pattern of bicycle related car crash data in NYC.

Select and generate data for visualization
```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9,fig.height=9}
Foutput <-  output%>% select(1:2,5:6,30) %>%  group_by(DATE) %>% summarise( c=sum(incidence, na.rm=T))
```


Using ggplot2 to visualize the seasonal pattern of bicycle related car crash data in NYC.

```{r, echo=TRUE,warning=FALSE,message=FALSE,tidy=F,eval=T,fig.width=9,fig.height=9}
Foutput <- output  %>%  select(1:2,5:6,30) %>%  group_by(DATE)  %>%  summarise( c=sum(incidence, na.rm=T))
library(ggplot2)
ggplot(data=Foutput, aes(x=as.Date(Foutput$DATE, format="%m/%d/%Y"), y=Foutput$c)) + geom_point() +
  geom_smooth(method = "auto", color= "red", linetype=1) +
  labs(title="# of Accidents Involving Bicycles Per Day",
       x="Date",
       y="# Accidents Involving Bicycles") +
  scale_x_date(date_breaks = "6 months", date_labels = "%b - %y")


# timeOutput <- output  %>%  select(1:2,5:6,30)  %>%  summarise( c=sum(incidence, na.rm=T))
# ggplot(data=Foutput, aes(x=as.Date(Foutput$TIME), y=Foutput$c)) + geom_point() +
#   geom_smooth(method = "auto", color= "red", linetype=1) +
#   labs(title="# of Accidents Involving Bicycles Per Day",
#        x="Date",
#        y="# Accidents Involving Bicycles") +
#   scale_x_date(date_breaks = "6 months", date_labels = "%b - %y")

```


# Visualizing the space pattern of bicycle related car crash data in NYC.

We visualized all the bicycle involved car accidents based on its geographic coordinates. Then we use inverse distance weighted (IDW) interpolation to mapping the car accidents in NYC.

IDW interpolation uses the measured values surrounding the prediction location. The measured values closest to the prediction location have more influence on the predicted value than those farther away. IDW assumes that each measured point has a local influence that diminishes with distance. It gives greater weights to points closest to the prediction location, and the weights diminish as a function of distance, hence the name inverse distance weighted.


<!-- ![](/home/hfshly/Desktop/INFM_750_Data_Processing/Coding_files/INFMTest_files/figure-html/ccccc.jpg) -->

